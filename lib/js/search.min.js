var VisualSearch=function($,_){$.widget("ui.autocomplete",$.ui.autocomplete,{_renderMenu:function(ul,items){var that=this,currentCategory="";$.each(items,function(index,item){if(item.category&&item.category!=currentCategory){ul.append("<li class='ui-autocomplete-category'>"+item.category+"</li>");currentCategory=item.category}var dom=that._renderItemData(ul,item);if(item.category&&item.category==currentCategory){dom.children().css({"padding-left":"14px","font-size":"12px"})}})}});$.fn.getCursorPosition=function(){var position=0;var input=this.get(0);if(document.selection){input.focus();var sel=document.selection.createRange();var selLen=document.selection.createRange().text.length;sel.moveStart("character",-input.value.length);position=sel.text.length-selLen}else if(input&&$(input).is(":visible")&&input.selectionStart!=null){position=input.selectionStart}return position};_.transpose=function(array){var keys=_.union.apply(_,_.map(array,_.keys)),result={};for(var i=0,l=keys.length;i<l;i++){var key=keys[i];result[key]=_.pluck(array,key)}return result};var VS=Backbone.View.extend({events:{"mousedown .VS-search-box":"clickBox","click .VS-cancel-search-box":"clearSearch","focus input":"unselect","keydown input":"inputkeydown","dblclick .VS-search-box":"highlightSearch"},initialize:function(){var self=this;this.options=_.extend({el:"",defaultquery:[],placeholder:"Hello I am the default placeholder",strict:true,search:$.noop},this.options);this.parameters=_.transpose(this.options.parameters);for(var i in this.parameters.parameter){this.parameters.category[i]={label:this.parameters.parameter[i],category:this.parameters.category[i]}}this.searchQuery=new VS.SearchQuery(this.options.defaultquery).on({"add remove change:editing":function(m){if(m.collection){self.options.search(JSON.stringify(m.collection.getComplete()))}},all:function(e,m){self.render()},"change:value":function(model){var index=self.searchQuery.indexOf(model);self.newParam({},index+1)}});this.bindKeys();this.render();$(document).on({click:function(e){if(!$(e.target).closest(".VS-search").length||!e.shiftKey){self.searchQuery.invoke("set",{selected:false})}},keydown:_.bind(this.keydown,self),keyup:_.bind(this.bindKeys,self)})},render:function(){var self=this,template=$(VS.template["search_box"](this.options)),placeholder=$(".VS-placeholder",template);this.parameterViews=[];if(this.searchQuery.length){placeholder.hide();$(".VS-search-inner",template).append(this.searchQuery.map(function(parameter){var parameterView=new VS.ParameterView({model:parameter}).render(self.parameters,self.options.strict).el;self.parameterViews.push(parameterView);return parameterView}))}else{placeholder.show()}this.$el.html(template);return this},clickBox:function(e,index){if(!$(e.target).is(".VS-search-box, .VS-search-inner, .VS-placeholder"))return;var self=this;for(var i in this.parameterViews){var parameterView=$(this.parameterViews[i]);if(parameterView.offset().top>e.pageY)break;if(parameterView.offset().top+parameterView.height()<e.pageY)continue;if(e.pageX<parameterView.offset().left){return _.delay(function(){self.newParam({},i)})}}i=i==this.parameterViews.length-1?this.parameterViews.length:i;_.delay(function(){self.newParam({},i)})},newParam:function(parameter,index){var paremeter=new VS.Parameter(parameter);this.searchQuery.add(paremeter,{at:index||null})},unselect:function(e){this.searchQuery.invoke("set",{selected:false})},clearSearch:function(e){this.searchQuery.reset()},highlightSearch:function(e){if(!$(e.target).is(".VS-search-box"))return;this.searchQuery.invoke("set",{selected:true})},inputkeydown:function(e){var self=this,editNext=function(){var selected=self.searchQuery.getEditing()[0],editing=selected.get("editing");if(editing===2){var index=self.searchQuery.indexOf(selected);selected.set("editing",false);self.newParam({},index+1)}else if(editing===false){var index=self.searchQuery.indexOf(selected);selected.destroy();var select=self.searchQuery.at(index);if(select){select.set("editing",0)}}else{selected.set("editing",editing+1)}},editPrevious=function(){var selected=self.searchQuery.getEditing()[0],editing=selected.get("editing");if(editing===0){var index=self.searchQuery.indexOf(selected);selected.set("editing",false);self.newParam({},index)}else if(editing===false){var index=self.searchQuery.indexOf(selected);selected.destroy();if(self.searchQuery.at(index-1)){self.searchQuery.at(index-1).set("editing",2)}}else{selected.set("editing",editing-1)}},keys={37:function(){if($(e.target).getCursorPosition()==0){editPrevious()}},39:function(){var input=$(e.target);if(input.getCursorPosition()==input.val().length){editNext()}},9:function(){if(e.shiftKey){e.preventDefault();editPrevious()}else{e.preventDefault();editNext()}}};return keys[e.keyCode]?keys[e.keyCode]():null},keydown:function(e){if(!e||$(".VS-search .selected").length===0){return}if([8,37,38,39,40].indexOf(e.keyCode)!=-1){return false}},bindKeys:function(e){if(!e||$(".VS-search .selected").length===0){return}var self=this,keys={8:function(){var selected=self.searchQuery.where({selected:true});selected.forEach(function(e){e.destroy()})},13:function(){var selected=self.searchQuery.where({selected:true});selected[0].set("editing",0)},39:function(){var selected=self.searchQuery.where({selected:true}),index=self.searchQuery.indexOf(_.last(selected)),moveTo=self.searchQuery.at(index+1);self.unselect();if(moveTo){moveTo.set("selected",true)}else{var paremeter=new VS.Parameter;self.searchQuery.add(paremeter,{at:index+1})}},37:function(){var selected=self.searchQuery.where({selected:true}),index=self.searchQuery.indexOf(_.first(selected)),moveTo=self.searchQuery.at(index-1);self.unselect();if(index===-1){self.searchQuery.at(self.searchQuery.length-1).set("selected",true)}else if(moveTo){moveTo.set("selected",true)}else{var paremeter=new VS.Parameter;self.searchQuery.add(paremeter,{at:0})}},38:function(){self.unselect();_.first(self.searchQuery.models).set("selected",true)},40:function(){self.unselect();_.last(self.searchQuery.models).set("selected",true)}};return keys[e.keyCode]?keys[e.keyCode]():null}});VS.template={search_box:_.template('<div class="VS-search">\n  <div class="VS-search-box-wrapper VS-search-box">\n    <div class="VS-icon VS-icon-search"></div>\n    <div class="VS-placeholder"><%= placeholder %></div>\n    <div class="VS-search-inner"></div>\n    <div class="VS-icon VS-icon-cancel VS-cancel-search-box" title="clear search"></div>\n  </div>\n</div>'),search_parameter:_.template('<div class="search_parameter_remove VS-icon VS-icon-cancel"></div><div class="parameter"><%- model.get(\'parameter\') %></div><div class="operator"><%- model.get(\'operator\') %></div><div class="value"><%- model.get(\'value\') %></div>')};VS.ParameterView=Backbone.View.extend({className:"search_parameter",events:{"focus input":"inputFocused","blur input":"inputBlurred",click:"click","click div.VS-icon-cancel":"delete","keydown input":"keydown"},render:function(parameters,strict){this.parameters=parameters||null;this.strict=strict||null;var self=this,template=$(VS.template["search_parameter"]({model:this.model}));this.$el.html(template);this.parameter={dom:$("<input/>").attr({autocomplete:"off",name:"parameter",value:this.model.get("parameter"),width:"10px"}),autocomplete:{minLength:0,delay:0,source:parameters.category,select:function(e,ui){this.value=ui.item.value;$(this).blur()}}};this.operator={dom:$("<input/>").attr({autocomplete:"off",name:"operator",placeholder:"==",value:this.model.get("operator"),size:"2"}),autocomplete:{minLength:0,delay:0,source:function(req,res){var parameter=self.model.get("parameter"),i=parameters.parameter.indexOf(parameter);if(parameters.operators[i]){res(parameters.operators[i])}else{res(["==","!=","<",">","≤","≥"])}},select:function(e,ui){this.value=ui.item.value;$(this).blur()}}};this.value={dom:$("<input/>").attr({autocomplete:"off",name:"value",value:this.model.get("value"),placeholder:this.model.get("placeholder"),type:this.model.get("type"),min:this.model.get("min"),max:this.model.get("max"),maxlength:this.model.get("maxlength"),size:this.model.has("value")?this.model.get("value").length:10}),autocomplete:{minLength:0,delay:0,source:function(req,res){var parameter=self.model.get("parameter"),i=parameters.parameter.indexOf(parameter);res(parameters.values[i])},select:function(e,ui){this.value=ui.item.value;$(this).blur()}}};if(!this.model.has("parameter")||this.model.get("editing")===0){this.autocomplete(this.$("div.parameter").html(this.parameter.dom).children(),this.parameter.autocomplete).focus(0)}else{if(!this.model.has("operator")||this.model.get("editing")===1){this.autocomplete(this.$("div.operator").html(this.operator.dom).children(),this.operator.autocomplete).focus(0)}else{if(!this.model.has("value")||this.model.get("editing")===2){this.autocomplete(this.$("div.value").html(this.value.dom).children(),this.value.autocomplete).focus(0)}else{if(this.model.get("selected")){this.$el.addClass("selected")}}}}return this},inputFocused:function(e){$(e.target).autocomplete("search","")},inputBlurred:function(e){var input=$(e.target),editing=this.model.get("editing");if(input.val().length===0){this.model.destroy()}else if(this.model.get(input.attr("name"))==input.val()&&editing!=1){this.model.set("editing",null)}else{var update={editing:editing<2?editing+1:null};update[input.attr("name")]=input.val();if(!editing){var self=this,i=this.parameters.parameter.indexOf(input.val());if(this.strict&&i===-1){return this.model.destroy()}_.extend(update,{type:self.parameters.type[i],placeholder:self.parameters.placeholder[i],min:self.parameters.min[i],max:self.parameters.max[i]})}this.model.set(update)}},click:function(e){if(e.target.localName=="input")return;var clicked=this.model.get("clicked");clearTimeout(clicked.timeout);clicked.timeout=setTimeout(function(){clicked.count=0},300);if(clicked.count>0){this.dblclick(e)}else{var self=this;_.delay(function(){self.model.set("selected",true)})}clicked.count++},dblclick:function(e){var target=$(e.target);if(target.is("div.parameter")){this.model.set("editing",0)}else if(target.is("div.operator")){this.model.set("editing",1)}else if(target.is("div.value")){this.model.set("editing",2)}},"delete":function(){this.model.destroy()},autocomplete:function(target,options){target.autocomplete(options).autocomplete("widget").addClass("VS-interface");return target},keydown:function(e){if(e.keyCode===13){$(e.target).blur()}if(e.keyCode===8&&$(e.target).getCursorPosition()===0&&$(e.target).getSelection().length===0){this.model.destroy()}}});VS.Parameter=Backbone.Model.extend({defaults:{parameter:null,value:null,placeholder:"",type:"text",operator:null,maxlength:null,max:null,min:null,selected:false,editing:false,clicked:{count:0,timeout:null}},incomplete:function(){return!(this.has("parameter")&&this.has("operator")&&this.has("value"))}});VS.SearchQuery=Backbone.Collection.extend({model:VS.Parameter,getEditing:function(){return _.filter(this.models,function(model){return $.isNumeric(model.get("editing"))||model.incomplete()})},getComplete:function(){return _.filter(this.models,function(model){return!model.incomplete()})}});return VS}(jQuery,_);